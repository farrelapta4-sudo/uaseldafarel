// ... (Bagian HTML dan CSS di atas) ...

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>

    <script>
        // --- KONFIGURASI MQTT WEBSOCKET ---
        const MQTT_BROKER = "broker.emqx.io";
        // Ubah ke 8084 (WSS/Secure WebSocket) untuk keamanan dan menghindari masalah Mixed Content di GitHub Pages (HTTPS)
        const MQTT_PORT = 8084; 
        const MQTT_TOPIC = "iot/pzem/data101";
        const MQTT_CLIENT_ID = "web_pzem_viewer_" + Math.random().toString(16).substr(2, 8); 
        
        const statusElement = document.getElementById('status');
        let reconnectTimeout = null;
        
        // Fungsi untuk menginisialisasi atau mencoba koneksi ulang
        function connectClient() {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            
            console.log(`Mencoba menghubungkan ke ${MQTT_BROKER}:${MQTT_PORT}...`);
            statusElement.className = 'status-connecting';
            statusElement.textContent = `Menghubungkan ke Broker...`;
            
            client.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                cleanSession: true,
                useSSL: true, // TRUE karena menggunakan port 8084 (WSS)
                timeout: 3, // Timeout koneksi 3 detik
            });
        }
        
        // Inisialisasi Klien MQTT - Menggunakan protocol wss (Secure WebSocket)
        // Jika broker tidak mendukung 8084, ganti 8084 menjadi 8083 dan useSSL menjadi false,
        // TAPI Anda berisiko terkena Mixed Content di GitHub Pages.
        const client = new Paho.MQTT.Client(MQTT_BROKER, Number(MQTT_PORT), "/ws", MQTT_CLIENT_ID);
        // Path /ws adalah default untuk Paho JS dan banyak broker

        // Atur fungsi callback
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // --- FUNGSI KONEKSI ---

        function onConnect() {
            console.log("Terhubung ke MQTT Broker via WSS!");
            statusElement.className = 'status-connected';
            statusElement.textContent = `Terhubung & Siap Menerima Data`;
            
            client.subscribe(MQTT_TOPIC, { qos: 0 });
            console.log(`Subscribed ke topik: ${MQTT_TOPIC}`);
        }
        
        function onFailure(responseObject) {
            console.log("Gagal Koneksi ke Broker: " + responseObject.errorMessage);
            statusElement.className = 'status-error';
            statusElement.textContent = `Gagal Koneksi: ${responseObject.errorMessage}. Mencoba ulang...`;
            // Atur timeout untuk mencoba koneksi ulang
            reconnectTimeout = setTimeout(connectClient, 5000); 
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Koneksi terputus: " + responseObject.errorMessage);
                statusElement.className = 'status-error';
                statusElement.textContent = `Koneksi Terputus: ${responseObject.errorMessage}. Mencoba ulang...`;
                // Atur timeout untuk mencoba koneksi ulang
                reconnectTimeout = setTimeout(connectClient, 5000); 
            }
        }
        
        // --- FUNGSI DATA ---

        function onMessageArrived(message) {
            try {
                const data = JSON.parse(message.payloadString);
                
                // Gunakan && !isNaN untuk memastikan nilai valid sebelum diproses
                
                const voltage = data.tegangan && !isNaN(data.tegangan) ? data.tegangan.toFixed(1) : '--';
                const current = data.arus && !isNaN(data.arus) ? data.arus.toFixed(3) : '--';
                const power   = data.daya && !isNaN(data.daya) ? data.daya.toFixed(1) : '--';
                const energy  = data.energi && !isNaN(data.energi) ? data.energi.toFixed(3) : '--';
                const frek    = data.frekuensi && !isNaN(data.frekuensi) ? data.frekuensi.toFixed(1) : '--';
                const pf      = data.pf && !isNaN(data.pf) ? data.pf.toFixed(2) : '--';


                document.getElementById('voltage').innerHTML = voltage + '<span class="unit">V</span>';
                document.getElementById('current').innerHTML = current + '<span class="unit">A</span>';
                document.getElementById('power').innerHTML = power + '<span class="unit">W</span>';
                document.getElementById('energy').innerHTML = energy + '<span class="unit">kWh</span>';
                document.getElementById('frequency').innerHTML = frek + '<span class="unit">Hz</span>';
                document.getElementById('pf').textContent = pf;
                
                // Efek visual update
                document.querySelectorAll('.data-card').forEach(card => {
                    card.style.borderColor = 'var(--accent-color)';
                    setTimeout(() => card.style.borderColor = 'var(--main-color)', 100);
                });

            } catch (e) {
                console.error("Gagal parsing JSON atau data tidak valid:", e);
            }
        }
        
        // Mulai koneksi saat dokumen dimuat
        connectClient();

    </script>
</body>
</html>
