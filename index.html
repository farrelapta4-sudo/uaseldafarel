<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZEM Data Monitor - Futuristik</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Modern/Futuristik dengan Seven Segment Style --- */
        :root {
            --bg-color: #0e111a; /* Latar Belakang Gelap */
            --main-color: #00ffc8; /* Warna Neon Hijau/Cyan */
            --accent-color: #ff0055; /* Warna Aksen Merah */
            --shadow-color: rgba(0, 255, 200, 0.7); /* Efek Glow */
            --font-digital: 'Orbitron', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--main-color);
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            text-align: center;
            background: rgba(18, 22, 30, 0.7); /* Semi-transparan */
            border-radius: 15px;
            padding: 40px 20px;
            border: 1px solid var(--shadow-color);
            box-shadow: 0 0 30px var(--shadow-color);
            backdrop-filter: blur(5px);
        }

        h1 {
            color: white;
            font-family: var(--font-digital);
            text-transform: uppercase;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 0 0 10px var(--main-color);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .data-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid var(--main-color);
            box-shadow: 0 0 15px rgba(0, 255, 200, 0.4);
            transition: transform 0.3s ease-in-out;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 25px var(--main-color);
        }

        .label {
            font-family: var(--font-digital);
            font-size: 0.9em;
            color: var(--main-color);
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        /* Gaya Seven Segment Digital */
        .value {
            font-family: var(--font-digital);
            font-size: 3em;
            font-weight: 700;
            color: var(--main-color);
            text-shadow: 0 0 5px var(--main-color), 0 0 20px var(--shadow-color);
            background: #000;
            padding: 10px 0;
            border-radius: 5px;
            border: 1px solid rgba(0, 255, 200, 0.2);
            min-height: 1.2em;
            display: block;
        }

        .unit {
            font-size: 1.2em;
            font-weight: 400;
            color: var(--accent-color);
            margin-left: 5px;
        }
        
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-family: var(--font-digital);
            font-size: 1em;
            transition: all 0.5s;
        }

        .status-connecting {
            color: orange;
            border: 1px solid orange;
        }

        .status-connected {
            color: var(--main-color);
            border: 1px solid var(--main-color);
            box-shadow: 0 0 5px var(--main-color);
        }
        
        .status-error {
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Monitor Daya PZEM</h1>
        
        <div id="status" class="status-connecting">Menghubungkan ke Broker...</div>

        <div class="grid-container">
            <div class="data-card">
                <div class="label">Tegangan (Voltage)</div>
                <div class="value" id="voltage">--<span class="unit">V</span></div>
            </div>

            <div class="data-card">
                <div class="label">Arus (Current)</div>
                <div class="value" id="current">--<span class="unit">A</span></div>
            </div>

            <div class="data-card">
                <div class="label">Daya (Power)</div>
                <div class="value" id="power">--<span class="unit">W</span></div>
            </div>

            <div class="data-card">
                <div class="label">Total Energi</div>
                <div class="value" id="energy">--<span class="unit">kWh</span></div>
            </div>

            <div class="data-card">
                <div class="label">Frekuensi</div>
                <div class="value" id="frequency">--<span class="unit">Hz</span></div>
            </div>
            
            <div class="data-card">
                <div class="label">Power Factor (PF)</div>
                <div class="value" id="pf">--</div>
            </div>
        </div>
        
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>

    <script>
        // --- KONFIGURASI MQTT WEBSOCKET ---
        // Ganti dengan Broker dan Topik Anda
        const MQTT_BROKER = "broker.emqx.io";
        const MQTT_PORT = 8083; // Port untuk koneksi WEBSOCKET (penting untuk browser!)
        const MQTT_TOPIC = "iot/pzem/data101";
        const MQTT_CLIENT_ID = "web_pzem_viewer_" + Math.random().toString(16).substr(2, 8); // ID unik
        
        // Elemen HTML
        const statusElement = document.getElementById('status');

        // Inisialisasi Klien MQTT
        // Menggunakan protocol ws (WebSocket)
        const client = new Paho.MQTT.Client(MQTT_BROKER, Number(MQTT_PORT), "/mqtt", MQTT_CLIENT_ID);

        // Atur fungsi callback
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // Mencoba koneksi
        client.connect({
            onSuccess: onConnect,
            onFailure: onFailure,
            cleanSession: true,
            useSSL: false // Karena menggunakan port 8083 (ws://)
        });

        function onConnect() {
            console.log("Terhubung ke MQTT Broker via WebSocket!");
            statusElement.className = 'status-connected';
            statusElement.textContent = `Terhubung ke ${MQTT_BROKER}`;
            
            // Subscribe ke Topik
            client.subscribe(MQTT_TOPIC, { qos: 0 });
            console.log(`Subscribed ke topik: ${MQTT_TOPIC}`);
        }
        
        function onFailure(responseObject) {
            console.log("Gagal Koneksi ke Broker: " + responseObject.errorMessage);
            statusElement.className = 'status-error';
            statusElement.textContent = `Gagal Koneksi: ${responseObject.errorMessage}`;
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Koneksi terputus: " + responseObject.errorMessage);
                statusElement.className = 'status-error';
                statusElement.textContent = `Koneksi Terputus: ${responseObject.errorMessage}`;
                // Coba reconnect (opsional)
                // setTimeout(() => client.connect({ onSuccess: onConnect, onFailure: onFailure }), 5000); 
            }
        }

        function onMessageArrived(message) {
            console.log("Pesan diterima di topik " + message.destinationName);
            
            try {
                // Parsing data JSON
                const data = JSON.parse(message.payloadString);
                
                // Update elemen HTML
                document.getElementById('voltage').innerHTML = data.tegangan.toFixed(1) + '<span class="unit">V</span>';
                document.getElementById('current').innerHTML = data.arus.toFixed(3) + '<span class="unit">A</span>';
                document.getElementById('power').innerHTML = data.daya.toFixed(1) + '<span class="unit">W</span>';
                document.getElementById('energy').innerHTML = data.energi.toFixed(3) + '<span class="unit">kWh</span>';
                document.getElementById('frequency').innerHTML = data.frekuensi.toFixed(1) + '<span class="unit">Hz</span>';
                document.getElementById('pf').textContent = data.pf.toFixed(2);
                
                // Tambahkan sedikit efek visual pada update
                document.querySelectorAll('.data-card').forEach(card => {
                    card.style.borderColor = 'var(--accent-color)';
                    setTimeout(() => card.style.borderColor = 'var(--main-color)', 100);
                });

            } catch (e) {
                console.error("Gagal parsing JSON:", e);
                console.log("Data mentah:", message.payloadString);
            }
        }

    </script>
</body>
</html>
